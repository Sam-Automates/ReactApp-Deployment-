name: ğŸš€ React Zero Downtime Deployment

# ğŸ”¥ Pipeline trigger
# main   â†’ Production
# staging â†’ Staging
on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    name: ğŸ› ï¸ Build & Deploy React App
    runs-on: ubuntu-latest

    steps:

      # ============================
      # ğŸŒ ENVIRONMENT SELECTION
      # ============================
      - name: ğŸŒ Detect Environment (Prod / Staging)
        id: env
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "ğŸš€ Production Deployment"
            echo "HOST=${{ secrets.PROD_HOST }}" >> $GITHUB_OUTPUT
            echo "USER=${{ secrets.PROD_USER }}" >> $GITHUB_OUTPUT
            echo "APP_DIR=/var/www/html/react-prod-app" >> $GITHUB_OUTPUT
          else
            echo "ğŸ§ª Staging Deployment"
            echo "HOST=${{ secrets.STAGING_HOST }}" >> $GITHUB_OUTPUT
            echo "USER=${{ secrets.STAGING_USER }}" >> $GITHUB_OUTPUT
            echo "APP_DIR=/var/www/html/react-staging-app" >> $GITHUB_OUTPUT
          fi

      # ============================
      # ğŸ” SECURE SSH DEPLOYMENT
      # ============================
      - name: ğŸ” Deploy via SSH (Zero Downtime)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.env.outputs.HOST }}
          username: ${{ steps.env.outputs.USER }}
          key: ${{ github.ref_name == 'main' && secrets.PROD_SSH_KEY || secrets.STAGING_SSH_KEY }}

          script: |
            set -e  # âŒ Exit immediately if any step fails

            # ============================
            # ğŸ“‚ BASIC VARIABLES
            # ============================
            APP_DIR=${{ steps.env.outputs.APP_DIR }}
            BRANCH=${{ github.ref_name }}

            echo "ğŸ“‚ App Directory: $APP_DIR"
            echo "ğŸŒ¿ Branch: $BRANCH"

            cd $APP_DIR

            # ============================
            # ğŸ” GIT SAFETY FIX
            # ============================
            echo "ğŸ” Marking repo as safe directory"
            git config --global --add safe.directory $APP_DIR

            # ============================
            # ğŸ“¥ CLONE REPO (IF NOT EXISTS)
            # ============================
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone https://${{ secrets.GH_PAT }}@github.com/${{ secrets.GH_USERNAME }}/react-app.git .
            fi

            # ============================
            # ğŸ”„ SYNC LATEST CODE
            # ============================
            echo "ğŸ”„ Syncing latest code"
            git fetch origin
            git checkout -B $BRANCH origin/$BRANCH
            git reset --hard origin/$BRANCH

            # ============================
            # ğŸ“¦ INSTALL DEPENDENCIES
            # ============================
            echo "ğŸ“¦ Installing npm dependencies"
            npm install

            # ============================
            # ğŸ—ï¸ BUILD APPLICATION
            # ============================
            echo "ğŸ—ï¸ Building React application"
            npm run build

            # ============================
            # âœ… BUILD VALIDATION
            # ============================
            echo "âœ… Validating build output"
            test -f dist/index.html

            # ============================
            # ğŸ” ZERO DOWNTIME SWAP
            # ============================
            echo "ğŸ” Performing atomic build swap"
            mv build build_old || true
            mv dist build

            # ============================
            # ğŸ§¹ CLEANUP
            # ============================
            echo "ğŸ§¹ Cleaning old build"
            rm -rf build_old

            echo "ğŸ‰ Deployment successful for $BRANCH"
